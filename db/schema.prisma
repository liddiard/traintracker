// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "sqlite"
}

enum NotificationType {
  arrival
  departure
}

enum TimeFormat {
  hr12
  hr24
}

model PushSubscription {
  id               String           @id @default(cuid())
  endpoint         String           // Browser-provided notification endpoint URL
  p256dh           String           // Encryption key
  auth             String           // Auth secret

  trainId          String           // e.g., "amtrak/97"
  stopCode         String           // e.g., "NYP"
  notificationType NotificationType // arrival | departure
  timeFormat       TimeFormat       // hr12 | hr24

  sent             Boolean          @default(false)
  createdAt        DateTime         @default(now())

  @@unique([endpoint, trainId, stopCode, notificationType])
  @@index([trainId, sent])
  @@index([endpoint])
}

// GTFS data models - populated at app startup
// https://gtfs.org/documentation/schedule/reference/#stopstxt
model GtfsStop {
  id                 String    @id // Format: "agency/stop_id" (e.g., "via/OTTW")
  stopId             String    // Original GTFS stop_id
  stopCode           String?   // stop_code (often the station code)
  stopName           String?
  stopDesc           String?
  stopLat            Float?
  stopLon            Float?
  zoneId             String?
  stopUrl            String?
  locationType       Int?      // 0=stop, 1=station, 2=entrance, etc.
  parentStation      String?
  stopTimezone       String?
  wheelchairBoarding Int?
  platformCode       String?
  agency             String    // "amtrak", "via", "brightline", etc.

  @@index([agency])
  @@index([stopCode])
}

// https://gtfs.org/documentation/schedule/reference/#tripstxt
model GtfsTrip {
  id                   String  @id // Namespaced as: `agency/trip_id`
  tripId               String  // Original GTFS `trip_id`
  routeId              String
  serviceId            String
  tripHeadsign         String?
  tripShortName        String?
  directionId          Int?
  blockId              String?
  shapeId              String?
  wheelchairAccessible Int?
  bikesAllowed         Int?
  agency               String

  @@index([agency])
  @@index([routeId])
  @@index([serviceId])
}

// https://gtfs.org/documentation/schedule/reference/#shapestxt
model GtfsShape {
  id                String  @id // Namespaced as: `agency/shape_id-shape_pt_sequence`
  shapeId           String  // Original GTFS `shape_id`
  ptLat             Float
  ptLon             Float
  ptSequence        Int
  distTraveled      Float?
  agency            String

  @@index([agency])
}

model GtfsImportMeta {
  id             String   @id @default("gtfs_import") // Singleton. Value should match `@app/constants.ts:GTFS_IMPORT_ID`
  lastImportedAt DateTime
}
