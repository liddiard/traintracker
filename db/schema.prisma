// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "sqlite"
}

enum NotificationType {
  arrival
  departure
}

enum TimeFormat {
  hr12
  hr24
}

model PushSubscription {
  id               String           @id @default(cuid())
  endpoint         String           // Browser-provided notification endpoint URL
  p256dh           String           // Encryption key
  auth             String           // Auth secret

  trainId          String           // e.g., "amtrak/97"
  stopCode         String           // e.g., "NYP"
  notificationType NotificationType // arrival | departure
  timeFormat       TimeFormat       // hr12 | hr24

  sent             Boolean          @default(false)
  createdAt        DateTime         @default(now())

  @@unique([endpoint, trainId, stopCode, notificationType])
  @@index([trainId, sent])
  @@index([endpoint])
}

// GTFS data models - populated at app startup
// https://gtfs.org/documentation/schedule/reference/#stopstxt
model GtfsStop {
  id                 String    @id // Format: "agency/stop_id" (e.g., "via/OTTW")
  agency             String    // "amtrak", "via", "brightline", etc.
  stopCode           String?   // stop_code (often the station code)
  stopName           String?
  stopLat            Float?
  stopLon            Float?
  stopTimezone       String?
  wheelchairBoarding Int?

  @@index([agency])
  @@index([stopCode])
}

// https://gtfs.org/documentation/schedule/reference/#tripstxt
model GtfsTrip {
  id                   String  @id // Namespaced as: `agency/trip_id`
  agency               String
  tripShortName        String?
  shapeId              String?

  @@index([agency])
  @@index([tripShortName])
}

model GtfsImportMeta {
  id             String   @id @default("gtfs_import") // Singleton. Value should match `@app/constants.ts:GTFS_IMPORT_ID`
  lastImportedAt DateTime
}
